/**
 * plugin.js
 *
 * Released under LGPL License.
 * Copyright (c) 1999-2015 Ephox Corp. All rights reserved
 *
 * License: http://www.tinymce.com/license
 * Contributing: http://www.tinymce.com/contributing
 */

/*jshint unused:false */
/*global tinymce:true */


/**
 * zsafile plugin that adds a toolbar button and menu item.
 */
tinymce.PluginManager.add('zsawidget', function(editor, url) {
	// Add a button that opens a window
	function openGalleryDialog(){
		// Select Element Clicked
	var selectedElement = null;
	editor.on('click', function (e) {
		selectedElement = e.target;
		addToolbars(editor, e.target);
	});
		// Open window with a specific url
		editor.windowManager.open({
			title: 'Add Widget',
			url: url + '/dialog.htm',
			width: 600,
			height: 400,
			buttons: [ 
				{text: 'Close', onclick: 'close'}
			],
			selection_toolbar: 'quicklink h2 h3 blockquote'
		},
		{
			parentElement: selectedElement
		});
	}
	
	editor.addButton('zsawidget', {
		text: 'Add Widgets',
		icon: false,
		onclick: openGalleryDialog 
	});

	// Adds a menu item to the tools menu
	editor.addMenuItem('zsawidget', {
		text: 'Add Widgets',
		context: 'insert',
		icon: false,
		onclick: openGalleryDialog
	});

	// Select Element Clicked
	var selectedElement = null;
	editor.on('click', function (e) {
		selectedElement = e.target;
		addToolbars(editor, e.target);
	});

	// Layout Toolbar
	var layoutToolbar = [
		'deleteLayout' //, '|', 'tableinsertrowbefore'
	];

	function hasClass(element, className) { 
		if (element.classList) { 
			return element.classList.contains(className); 
		} 
		else { 
			return new RegExp('(^| )' + className + '( |$)', 'gi').test(element.className); 
		}  
        return false; 
    } 
	// Add Toolbars
	var addToolbars = function (editor, target) {
		var isLayout = function (target) {
			var currentElement=target;
			while(currentElement){
				if(hasClass(currentElement, "widgetContainer")){ 
					return true;
				}
				currentElement=currentElement.parentNode;
			}
			return false;
		};
		editor.addContextToolbar(
			isLayout,
			layoutToolbar.join(' ')
		);
	};
	
	editor.addButton('deleteLayout', {
		type: 'button',
		title: 'Delete Row',
		icon: 'mce-ico mce-i-tabledelete',
		onclick: function () {  
			var currentElement=selectedElement;
			while(currentElement){ 
				if(hasClass(currentElement, "widgetSection")){ 
					// TODO: we couldn't figure out how to integrate with undo/redo bookmark selection stuff
					currentElement.parentNode.removeChild(currentElement); // TODO: delete button removes all widgetSection elements on top level. Maybe use widgetSection class inside widgetContainer somehow.

					var panels=document.getElementsByClassName("mce-floatpanel");
					for(var i=0;i<panels.length;i++){
						panels[i].style.display='none'; 
					}
					return;
				}
				currentElement=currentElement.parentNode;
			}
		}
	  }); 
});
